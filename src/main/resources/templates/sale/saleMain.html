<!DOCTYPE html>
<html lang="en">
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ìš°ë™í–‰</title>
    <link rel="stylesheet" th:href="@{/css/mainDesign.css}" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>

        .title-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 20px 20px;
            position: relative;
        }
        .title {
            font-family: 'Freesentation-9Black', sans-serif;
            font-weight: bold;
            margin:0;
            text-align: center;
        }
       .btn-udh-blue{
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            right: 0;
        }
        .search-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .search-input {
            width: 300px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px 0 0 5px;
            height: 40px;
            box-sizing: border-box;
        }
        .search-button {
            background-color: #FFB83D;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .search-button:hover {
            background-color: #FF9909;
            color: #FFFFFF;
        }
        .sale-cards {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 20px;
            max-width: 1200px;
            margin: 50px auto;
        }
        .sale-card {
            width: 500px;
            height: 300px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: box-shadow 0.3s ease;
        }
        .sale-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* í˜¸ë²„ ì‹œ ê·¸ë¦¼ì íš¨ê³¼ */
            }
        .sale-card img {
            width: 250px;
            height: calc(100% - 30px);
            object-fit: cover;
            object-position: center;
            margin-left: 20px;
        }
        .sale-card-content {
            width: 60%;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 1.0em;
        }
        .sale-card-description {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        .sale-card-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sale-card-title {
            font-weight: bold;
            font-size: 1.5em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .sale-card-content {
            flex: 1;
            margin-bottom: 10px;
        }
        .sale-card-price {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .original-price {
            text-decoration: line-through;
            color: #888;
            margin-bottom: 5px;
        }
        .sale-price {
            font-weight: bold;
            color: #ff4500;
            font-size: 1.5em;
        }
        .sale-card-timer {
            font-weight: bold;
            color: #ffffff;
            background-color: #CB3333;
            padding: 5px 10px;
            border-radius: 30px;
            font-size: 0.9em;
            white-space: nowrap;
            display: inline-block;
            max-width: 45%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .sale-card-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .page-button {
            margin: 0 5px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            background-color: #3B5C9A;
            cursor: pointer;
            color: white;
            border-radius: 10px;
         }

        .page-button.active {
            background-color: #0B1D40;
            color: white;
        }
        .filter-container {
            position: absolute;
            right: 0;
            bottom: -30px;
            display: flex;
            align-items: center;
        }

        .filter-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            cursor: pointer;
        }
        .search-and-filter-container {
            max-width: 1200px;
            margin: 0 auto 20px;
            position: relative;
        }
        .filter-container .spacer {
            display: inline-block;
            width: 10px; 
        }

    </style>

</head>
<body>

<div th:replace="~{/common/menubar}"></div>
<div class="title-container">
    <h6 class="title">â°ìš°ë¦¬ë™ë„¤ ë•¡ì²˜ë¦¬</h6>
    <a th:if="${#authorization.expression('hasRole(''ROLE_SELLER'')')}" href="saleInsertForm">
        <button class="btn-udh-blue">ê¸€ ì‘ì„±</button>
    </a>
</div>

<form method="GET" th:action="@{/sale/saleMain}">
    <div class="search-and-filter-container">
        <div class="search-container">
            <input type="text" name="search" class="search-input" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”." th:value="${param.search}">
            <button class="search-button" type="submit">ê²€ìƒ‰</button>
        </div>
        <div class="filter-container">
            <input type="checkbox" id="excludeExpired" name="excludeExpired" th:checked="${param.excludeExpired}">
            <label for="excludeExpired">ë§ˆê°ì œì™¸</label>
            <span class="spacer"></span>
            <select id="sortOption" name="sortOption">
                <option value="latest" th:selected="${param.sortOption == 'latest'}">ìµœì‹ ìˆœ</option>
                <option value="deadline" th:selected="${param.sortOption == 'deadline'}">ë§ˆê°ì„ë°•ìˆœ</option>
                <option value="lowPrice" th:selected="${param.sortOption == 'lowPrice'}">ë‚®ì€ê°€ê²©ìˆœ</option>
            </select>
        </div>
    </div>
</form>
<div class="sale-cards" id="saleCards">

    <div th:each="sale : ${sales}" class="sale-card" >
        <div class="sale-card-header">
            <h3 class="sale-card-title" th:text="${sale.title}">ë•¡ì²˜ë¦¬ ì œëª©</h3>
            <div class="sale-card-timer" th:attr="data-start-time=${sale.startedAt}, data-end-time=${sale.endedAt}">00:00:00</div>
        </div>
        <div class="sale-card-body">
            <div th:if="${sale.attachments != null and !sale.attachments.empty}">
                <img th:src="@{'/uploadFiles/' + ${sale.attachments[0].savedName}}" alt="ìƒí’ˆ ì´ë¯¸ì§€">
            </div>
            <div class="sale-card-content">
                <p class="sale-card-description" th:text="${sale.content}">ë•¡ì²˜ë¦¬ ì„¤ëª…</p>
                <div class="sale-card-price">
                    <span class="original-price" th:text="${#numbers.formatDecimal(sale.originalPrice, 0, 'COMMA', 0, 'POINT')} + 'ì›'">ì •ìƒ ê°€ê²©</span>
                    <span class="sale-price" th:text="${#numbers.formatDecimal(sale.salePrice, 0, 'COMMA', 0, 'POINT')} + 'ì›'">í• ì¸ ê°€ê²©</span>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="pagination" id="pagination">

</div>

<script th:inline="javascript">
    const sales = /*[[${sales}]]*/ [];
    let currentPage = 1;
    const itemsPerPage = 4;
    let filteredSales = [...sales];

    document.addEventListener('DOMContentLoaded', function() {
        const excludeExpiredCheckbox = document.getElementById('excludeExpired');
        const sortOptionSelect = document.getElementById('sortOption');

        // ë¡œë“œì‹œ í˜ì´ì§€ ë²ˆí˜¸ ì½ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const pageFromUrl = urlParams.get('page');
        if (pageFromUrl) {
            currentPage = parseInt(pageFromUrl);
        }

        excludeExpiredCheckbox.addEventListener('change', () => {
            filterSales();
            applySorting();
            displaySales(1);
        });

        sortOptionSelect.addEventListener('change', () => {
            applySorting();
            displaySales(1);
        });

        document.querySelector('.search-button').addEventListener('click', function(event) {
            event.preventDefault();
            const searchTerm = document.querySelector('.search-input').value;
            const excludeExpired = document.getElementById('excludeExpired').checked;
            const excludeExpiredParam = excludeExpired ? `&excludeExpired=${excludeExpired}` : '';
            window.location.href = `/sale/saleMain?search=${encodeURIComponent(searchTerm)}${excludeExpiredParam}`;
        });

        filterSales();
        applySorting();
        displaySales(currentPage);
        updateTimers();
        setInterval(updateTimers, 1000);  // 1ì´ˆë§ˆë‹¤ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
    });

    function filterSales() {
        const excludeExpired = document.getElementById('excludeExpired').checked;
        const now = new Date().getTime();

        filteredSales = sales.filter(sale => {
            const endTime = new Date(sale.endedAt).getTime();
            return !(excludeExpired && endTime < now);
        });
    }

    function applySorting() {
        const sortOption = document.getElementById('sortOption').value;

        switch(sortOption) {
            case 'latest':
                filteredSales.sort((a, b) => new Date(b.startedAt) - new Date(a.startedAt));
                break;
            case 'deadline':
                filteredSales.sort((a, b) => {
                    const now = new Date().getTime();
                    const aTimeLeft = new Date(a.endedAt).getTime() - now;
                    const bTimeLeft = new Date(b.endedAt).getTime() - now;
                    return aTimeLeft - bTimeLeft;  // ë‚¨ì€ ì‹œê°„ì´ ì ì€ ìˆœìœ¼ë¡œ ì •ë ¬
                });
                break;
            case 'lowPrice':
                filteredSales.sort((a, b) => a.salePrice - b.salePrice);
                break;
        }
    }

    function updateTimers() {
        const now = new Date().getTime();
        document.querySelectorAll('.sale-card-timer').forEach(timer => {
            const startTime = new Date(timer.getAttribute('data-start-time')).getTime();
            const endTime = new Date(timer.getAttribute('data-end-time')).getTime();
            const saleId = timer.getAttribute('data-sale-id');
            const saleStatus = timer.getAttribute('data-status');

            if (saleStatus === 'closed' || now >= endTime) {
                // íƒ€ì´ë¨¸ê°€ ëë‚œ ê²½ìš°
                timer.innerHTML = "ë•¡ì²˜ë¦¬ ë§ˆê°";
                timer.closest('.sale-card').classList.add('closed-sale'); // ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ ì¶”ê°€
                // ì„œë²„ì— ìƒíƒœ ì—…ë°ì´íŠ¸ ìš”ì²­
                if (saleStatus !== 'closed') {
                    updateSaleStatusToClosed(saleId, timer);
                }
            } else if (now < startTime) {
                // íŒë§¤ ì‹œì‘ ì „
                timer.innerHTML = "íŒë§¤ ì˜ˆì •";
            } else {
                // íŒë§¤ ì¤‘ (ì¹´ìš´íŠ¸ë‹¤ìš´)
                const remainingTime = endTime - now;
                const hours = Math.floor(remainingTime / (1000 * 60 * 60));
                const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
                timer.innerHTML = `ğŸ•“ ${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        });
    }

    function updateSaleStatusToClosed(saleId, timerElement) {
        $.ajax({
            url: '/sale/updateStatus/' + saleId,
            type: 'POST',
            data: JSON.stringify({ status: 'closed' }),
            contentType: 'application/json',
            success: function(response) {
                console.log("Sale status updated to closed.");
                // ìƒíƒœ ì—…ë°ì´íŠ¸ ì„±ê³µ ì‹œ íƒ€ì´ë¨¸ì˜ ìƒíƒœë¥¼ 'closed'ë¡œ ì—…ë°ì´íŠ¸
                timerElement.setAttribute('data-status', 'closed');
                timerElement.closest('.sale-card').classList.add('closed-sale'); // ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ ì¶”ê°€
            },
            error: function(xhr, status, error) {
                console.error("Error updating sale status:", error);
            }
        });
    }

    function displaySales(page) {
        currentPage = page;
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const salesToDisplay = filteredSales.slice(startIndex, endIndex);

        const saleCardsContainer = document.getElementById('saleCards');
        saleCardsContainer.innerHTML = '';

        salesToDisplay.forEach((sale, index) => {
            const saleCard = document.createElement('div');
            saleCard.className = 'sale-card';
            saleCard.innerHTML = `
                <div class="sale-card-header">
                    <h3 class="sale-card-title">${sale.title}</h3>
                    <div class="sale-card-timer" data-sale-id="${sale.saleNo}" data-start-time="${sale.startedAt}" data-end-time="${sale.endedAt}" data-status="${sale.status}">
                        ${sale.status === 'closed' ? 'ë•¡ì²˜ë¦¬ ë§ˆê°' : '00:00:00'}
                    </div>
                </div>
                <div class="sale-card-body">
                    <div>
                        ${sale.attachments && sale.attachments.length > 0
                            ? `<img src="/uploadFiles/${sale.attachments[0].savedName}" alt="ìƒí’ˆ ì´ë¯¸ì§€">`
                            : ''}
                    </div>
                    <div class="sale-card-content">
                        <p class="sale-card-description">${sale.content}</p>
                        <div class="sale-card-price">
                            <span class="original-price">${sale.originalPrice.toLocaleString()}ì›</span>
                            <span class="sale-price">${sale.salePrice.toLocaleString()}ì›</span>
                        </div>
                    </div>
                </div>
            `;
            saleCard.addEventListener('click', () => {
                window.location.href = `/sale/detail/${sale.saleNo}`; // ìƒì„¸ í˜ì´ì§€ URLë¡œ ì´ë™
            });
            saleCardsContainer.appendChild(saleCard);

            // ì´ë¯¸ closed ìƒíƒœì¸ ê²½ìš°, ì¹´ë“œ ë¹„í™œì„±í™”
            if (sale.status === 'closed') {
                saleCard.classList.add('closed-sale'); // ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ ì¶”ê°€
            }
        });

        updateTimers();
        updatePagination();
        window.history.pushState(null, null, `?page=${page}`);
    }

    function updatePagination() {
        const totalPages = Math.ceil(filteredSales.length / itemsPerPage);
        const paginationContainer = document.getElementById('pagination');
        paginationContainer.innerHTML = '';

        for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i;
            pageButton.classList.add('page-button');
            if (i === currentPage) {
                pageButton.classList.add('active');
            }
            pageButton.addEventListener('click', () => {
                displaySales(i);
            });
            paginationContainer.appendChild(pageButton);
        }
    }
</script>

</body>
</html>